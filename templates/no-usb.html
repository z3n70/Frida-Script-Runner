{% extends "base.html" %}

{% block title %}
    <title>Frida Script Runner | Dashboard</title>
{% endblock %}

{% block body %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/no-usb.css') }}" class="rel">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <img src="{{ url_for('static', filename='img/FSR-logo.png') }}" alt="FSR Logo" class="dashboard-logo">
            <h1 class="dashboard-title">Frida Script Runner</h1>
            <p class="dashboard-subtitle">Choose a feature to get started</p>
        </div>
        
        <div class="usb-status-container" id="usbStatusContainer">
            <div class="usb-status-header">
                <i class="bi bi-usb-symbol"></i>
                <span class="usb-status-title">USB Device Monitor</span>
                <span class="usb-status-indicator" id="statusIndicator">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Scanning...</span>
                </span>
            </div>
            <div class="device-selector-container" id="deviceSelectorContainer" style="display: none;">
                <label for="deviceSelect" class="device-select-label">
                    <i class="bi bi-device-hdd"></i>
                    Select Device:
                </label>
                <div class="device-select-wrapper">
                    <select id="deviceSelect" class="device-select">
                        <option value="">Loading devices...</option>
                    </select>
                    <button id="refreshDevicesBtn" class="refresh-devices-btn" title="Refresh devices">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="usb-status-content" id="usbStatusContent">
                <div class="status-loading">
                    <div class="spinner"></div>
                    <p>Checking for connected devices...</p>
                </div>
            </div>
        </div>
        
        <div class="dashboard-cards-scroll">
            <div class="dashboard-cards">
                <div class="dashboard-card" onclick="window.location.href='/'">
                <div class="card-icon">
                    <i class="bi bi-terminal"></i>
                </div>
                <h3 class="card-title">Frida Script Runner</h3>
                <p class="card-description">Run and manage Frida scripts on connected devices</p>
                </div>
                <div class="dashboard-card" onclick="window.location.href='/sslpindec'">
                <div class="card-icon">
                    <i class="bi bi-phone"></i>
                </div>
                <h3 class="card-title">SSL Pinning Detector</h3>
                <p class="card-description">Detect SSL Pinning on your application</p>
                </div>
                <div class="dashboard-card" onclick="window.location.href='/features'">
                <div class="card-icon">
                    <i class="bi bi-grid-3x3-gap"></i>
                </div>
                <h3 class="card-title">APK & IPA Dump</h3>
                <p class="card-description">Dump APK & IPA from device</p>
                </div>
                
                <div class="dashboard-card" onclick="window.location.href='#apk-analyzer'">
                <div class="card-icon">
                    <i class="bi bi-file-earmark-binary"></i>
                </div>
                <h3 class="card-title">APK & IPA Analyzer</h3>
                <p class="card-description">Analyze APK & IPA files and extract information</p>
                </div>
                
                <div class="dashboard-card" onclick="window.location.href='/apk-downloader'">
                <div class="card-icon">
                    <i class="bi bi-download"></i>
                </div>
                <h3 class="card-title">APK & IPA Downloader</h3>
                <p class="card-description">Download APK & IPA files from connected devices</p>
                </div>

                <div class="dashboard-card" onclick="window.location.href='/mobile-proxy'">
                <div class="card-icon">
                    <i class="bi bi-globe2"></i>
                </div>
                <h3 class="card-title">Mobile Proxy</h3>
                <p class="card-description">Configure and manage Proxy settings</p>
                </div>
                
                <div class="dashboard-card" onclick="window.location.href='/adb-gui'">
                <div class="card-icon">
                    <i class="bi bi-gear"></i>
                </div>
                <h3 class="card-title">ADB GUI</h3>
                <p class="card-description">Configure and manage ADB GUI</p>
                </div>
                
                <div class="dashboard-card" onclick="window.location.href='#terminal'">
                <div class="card-icon">
                    <i class="bi bi-terminal-fill"></i>
                </div>
                <h3 class="card-title">Terminal</h3>
                <p class="card-description">Run and manage Frida scripts on connected devices</p>
                </div>
                
                <div class="dashboard-card" onclick="window.location.href='#settings'">
                <div class="card-icon">
                    <i class="bi bi-sliders"></i>
                </div>
                <h3 class="card-title">Settings</h3>
                <p class="card-description">Application settings and preferences</p>
                </div>
            </div>
        </div>
        
        <div class="dashboard-footer text-center mt-4 mb-3 w-100">
            <a class="credit d-inline-block" href="https://secrash.com" target="_blank"><span>2025 Â© Secrash</span></a>
          </div>
    </div>
    
    <script>
        let deviceCheckInterval;
        let lastDeviceCount = 0;
        let allDevicesList = [];
        
        function loadDevicesList() {
            fetch('/api/devices/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.devices && data.devices.length > 0) {
                        allDevicesList = data.devices;
                        populateDeviceSelector(data.devices);
                        showDeviceSelector();
                        
                        if (data.devices.length === 1 && !sessionStorage.getItem('selectedDevice')) {
                            const deviceSelect = document.getElementById('deviceSelect');
                            deviceSelect.value = data.devices[0].identifier || data.devices[0].device_id || data.devices[0].udid || '';
                            sessionStorage.setItem('selectedDevice', deviceSelect.value);
                            updateSelectedDeviceInfo();
                        }
                    } else {
                        hideDeviceSelector();
                        sessionStorage.removeItem('selectedDevice');
                    }
                })
                .catch(error => {
                    console.error('Error loading devices list:', error);
                    hideDeviceSelector();
                });
        }
        
        function populateDeviceSelector(devices) {
            const deviceSelect = document.getElementById('deviceSelect');
            
            const newSelect = deviceSelect.cloneNode(true);
            deviceSelect.parentNode.replaceChild(newSelect, deviceSelect);
            const deviceSelectNew = document.getElementById('deviceSelect');
            
            deviceSelectNew.innerHTML = '';
            
            if (devices.length === 0) {
                deviceSelectNew.innerHTML = '<option value="">No devices found</option>';
                return;
            }
            
            deviceSelectNew.innerHTML = '<option value="">Select a device...</option>';
            
            devices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.identifier || device.device_id || device.udid || '';
                option.textContent = device.display_name || `${device.type} Device`;
                option.dataset.deviceType = device.type;
                option.dataset.deviceIndex = index;
                deviceSelectNew.appendChild(option);
            });
            
            const savedDevice = sessionStorage.getItem('selectedDevice');
            if (savedDevice) {
                const option = Array.from(deviceSelectNew.options).find(opt => opt.value === savedDevice);
                if (option) {
                    deviceSelectNew.value = savedDevice;
                    updateSelectedDeviceInfo();
                }
            }
            
            deviceSelectNew.addEventListener('change', function() {
                const selectedValue = this.value;
                if (selectedValue) {
                    sessionStorage.setItem('selectedDevice', selectedValue);
                    updateSelectedDeviceInfo();
                } else {
                    sessionStorage.removeItem('selectedDevice');
                }
            });
        }
        
        function updateSelectedDeviceInfo() {
            const deviceSelect = document.getElementById('deviceSelect');
            const selectedValue = deviceSelect.value;
            if (!selectedValue) return;
            
            const selectedDevice = allDevicesList.find(d => 
                (d.identifier || d.device_id || d.udid) === selectedValue
            );
            
            if (selectedDevice) {
                const statusText = document.getElementById('statusText');
                statusText.textContent = `Selected: ${selectedDevice.display_name || selectedDevice.model || 'Device'}`;
            }
        }
        
        function showDeviceSelector() {
            const container = document.getElementById('deviceSelectorContainer');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        function hideDeviceSelector() {
            const container = document.getElementById('deviceSelectorContainer');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function checkDeviceStatus() {
            fetch('/check-device-status')
                .then(response => response.json())
                .then(data => {
                    updateDeviceStatus(data);
                    loadDevicesList();
                })
                .catch(error => {
                    console.error('Error checking device status:', error);
                    updateDeviceStatus({
                        connected: false,
                        device_count: 0,
                        devices: [],
                        message: 'Error checking device status'
                    });
                });
        }
        
        function updateDeviceStatus(data) {
            const statusContainer = document.getElementById('usbStatusContainer');
            const statusContent = document.getElementById('usbStatusContent');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (data.connected && data.device_count > 0) {
                statusDot.className = 'status-dot status-connected';
                statusText.textContent = `${data.device_count} Device(s) Connected`;
                
                let devicesHtml = '<div class="devices-list">';
                data.devices.forEach((device, index) => {
                    devicesHtml += `
                        <div class="device-item">
                            <div class="device-icon">
                                <i class="bi ${device.type === 'Android' ? 'bi-android' : 'bi-apple'}"></i>
                            </div>
                            <div class="device-info">
                                <div class="device-name">${device.model || 'Unknown Device'}</div>
                                <div class="device-details">
                                    <span class="device-type">${device.type}</span>
                                    ${device.android_version ? `<span class="device-version">Android ${device.android_version}</span>` : ''}
                                    ${device.serial_number ? `<span class="device-serial">SN: ${device.serial_number}</span>` : ''}
                                </div>
                            </div>
                            <div class="device-status-badge connected">
                                <i class="bi bi-check-circle"></i> Connected
                            </div>
                        </div>
                    `;
                });
                devicesHtml += '</div>';
                
                statusContent.innerHTML = devicesHtml;
                
                if (data.device_count > lastDeviceCount && lastDeviceCount === 0) {
                    setTimeout(() => {
                        if (confirm('Device detected! Would you like to go to Frida Script Runner?')) {
                            window.location.href = '/';
                        }
                    }, 2000);
                }
                
                lastDeviceCount = data.device_count;
            } else {
                statusDot.className = 'status-dot status-disconnected';
                statusText.textContent = 'No Device Connected';
                
                statusContent.innerHTML = `
                    <div class="no-device-message">
                        <i class="bi bi-usb-drive"></i>
                        <p>Please connect your Android or iOS device via USB</p>
                        <p class="help-text">Make sure USB debugging is enabled and device is properly connected</p>
                    </div>
                `;
                
                lastDeviceCount = 0;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkDeviceStatus();
            loadDevicesList();
            deviceCheckInterval = setInterval(checkDeviceStatus, 3000);
            
            const refreshBtn = document.getElementById('refreshDevicesBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    loadDevicesList();
                    checkDeviceStatus();
                });
            }
        });
        
        window.addEventListener('beforeunload', function() {
            if (deviceCheckInterval) {
                clearInterval(deviceCheckInterval);
            }
        });
    </script>
{% endblock %}
